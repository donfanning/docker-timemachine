#!/bin/bash

set -e

if [[ $# -lt 5 ]]; then
  echo "Usage: add-account USERNAME PASSWORD MOUNT_POINT SHARE_NAME TIMEMACHINE(yes,no) [VOL_SIZE_MB]"
  exit 1
fi

if [ $(getent group afpuser) ]; then
  echo "group afpuser already exsist."
else
  echo "group afpuser does not exist."
  echo "creating group..."
  if [ !$(addgroup afpuser) ]; then
    echo "group created."
  else
    echo "couldnt create group."
    exit 1
  fi
fi
# Add the user
echo "adding user [${1}]"
adduser -S -H -G afpuser $1
echo $1:$2 | chpasswd

# Create mountpoint
echo "creating mountpoint [${3}] with name [${4}]"
mkdir -p /shares/$3
chown -R $1:afpuser /shares/$3

# Add config to timemachine
  echo "
[${4}]
    path = /shares/${3}
    time machine = ${5}
    valid users = ${1}" >> /etc/afp.conf

if [[ $# -eq 6 ]]; then
  echo "
    vol size limit = ${6}" >> /etc/afp.conf
fi

echo "done creating mountpoint and user"
#to be fixed
chmod +x /usr/bin/add-share
echo "restarting AFP service..."
pkill -HUP afpd
echo "restarted!"
